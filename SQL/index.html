<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" /> 
  <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Select By Attributes</title> 
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/esri/css/esri.css">
    <link rel="stylesheet" href="SQLquery.css" type="text/css" media="screen, projection" />
    <style>
      html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
    </style>
    <script type="text/javascript">djConfig = { parseOnLoad:true };</script> 
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/"></script>
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.14/jquery-ui.min.js"></script>
    <script language="javascript" src="SQLquery.js"></script> 
    <script>
    	$(function() {
    		$( "#wrapper" ).draggable();
    	});
    	</script>
    <script type="text/javascript"> 
      dojo.require("esri.map");
      dojo.require("esri.layers.FeatureLayer");
      dojo.require("dijit.form.Button");
      dojo.require("dijit.Dialog");

      var feMap = {};
      var userConfig = {};
      userConfig.layers = [
      	{
      		"id": "LGA",
      		"layerType": "feature",
      		"url": "http://services.azuron.com/arcgis/rest/services/ABS/BasicCommunityProfile_2011/MapServer/2",
      		"layerInfo": {
      			"title": "Local government areas",
      			"minScale": 50000,
      			"maxScale": 100000,
      			"queryable": true
      		},
      		"attributes": [
      		{
      			"name": "Name",
				"type": "esriFieldTypeString",
				"alias": "Name",
				"query": true
      		}, {
      			"name": "Tot_P_P",
				"type": "esriFieldTypeInteger",
				"alias": "Total population",
				"query": true
      		}, {
      			"name": "Age_0_4_yr_F",
      			"type": "esriFieldTypeInteger",
      			"alias": "Age 0 - 4",
      			"query": false
      		}]	
      	},{
      	
      	  "id":"world-heritage",
      	  "layerType":"feature",
      	  "url":"http://services.azuron.com/arcgis/rest/services/GeoScience/ProtectedAreas/MapServer/1",
      	  "layerInfo":{
      	    "title":"World Heritage areas",
      	    "description":"Areas listed by UNESCO as World Heritage sites in New South Wales.",
      	    "visible":true,
      	    "showLegend":true,
      	    "queryable": true
      	  },
      	  "attributes":[
      	    {
      	      "name":"WHA_NAME",
      	      "alias":"Name",
      	      "type": "esriFieldTypeString",
      	      "query": true
      	    },
      	    {
      	      "alias":"Area (sqm)",
      	      "type": "esriFieldTypeDouble",
      	      "name":"Shape_Area"
      	    }
      	  ],
      	  "infoWindow":{
      	    "title":"World Heritage Area"
      	  }
      	},{
      	
      	  "url":"http://services.azuron.com/arcgis/rest/services/GeoScience/ProtectedAreas/MapServer/0",
      	  "layerType":"feature",
      	  "mode":"snapshot",
      	  "clusterImage":"",
      	  "id":"declared-wilderness",
      	  "layerInfo":{
      	    "title":"Declared Wilderness areas",
      	    "description":"Boundaries of declared wilderness areas in NSW under S.59(1) of the NP&W Act 1974 and S.8 of the Wilderness Act 1987. Wilderness Act 1987. The Wilderness Act 1987 was introduced to identify, protect and manage wilderness areas.",
      	    "definitionExpression":"",
      	    "visible":true,
      	    "transparency":"",
      	    "transparencySlider":false,
      	    "showLegend":true,
      	    "minScale":"",
      	    "maxScale":""
      	  },
      	  "infoWindow":{
      	    "title":"Declared Wilderness",
      	    "height":"",
      	    "width":""
      	  },
      	  "click":true,
      	  "hover":true,
      	  "attributes":[
      	    {
      	      "name":"DECNAME",
      	      "alias":"Name"
      	    },
      	    {
      	      "name":"FIRSTDATE",
      	      "alias":"Dedication date"
      	    }
      	  ]
      	}
      ]
      
      function init() {
        var extent = new esri.geometry.Extent({"xMin": 15000000,"yMin": -4500000,"xMax": 17500000,"yMax": -3000000,"spatialReference":{"wkid":102113}});
        
        feMap.mapFrame = new esri.Map("map",{
          basemap: "topo",
          center: [151, -32.5],
          zoom: 10
        });
        
        //Add layers
        feMap.SQLqueryLayers = [];
        for(var i = 0; i < userConfig.layers.length; i++) {
        
	        var template = new esri.InfoTemplate("info window","${*}");
	        var featDef = userConfig.layers[i];
	        var outFields = [];
	        for(var x = 0; x < featDef.attributes.length; x++) {
	        	var outField = featDef.attributes[x].name;
	        	outFields.push(outField);        
	        }        
	        
	        var featureLayer = new esri.layers.FeatureLayer(featDef.url,{
	          mode: esri.layers.FeatureLayer.MODE_ONDEMAND,
	          outFields: outFields,
	          infoTemplate:template
	        });
	        
	        feMap.mapFrame.addLayer(featureLayer);
	        if(featDef.layerInfo.queryable) {feMap.SQLqueryLayers.push(featDef);}
	    }
        
        
        jQuery("#btnSQLquery").click(function () {
        	if(jQuery("#SQLquery").is(":visible")) {
	        	jQuery("#SQLquery").hide();
	        } else {
	        	//Populate the layers list with all queryable layers
	        	jQuery("#SQLLayerList").empty();
	        	for(var x = 0; x < feMap.SQLqueryLayers.length; x++) {
	        		var queryLayer = feMap.SQLqueryLayers[x];
	        		var name = queryLayer.layerInfo.title;
	        		var id = queryLayer.id;	
	        		jQuery("#SQLLayerList").append(new Option(name,id));
	        	
	        	}
	        	updateSQLqueryFields();    
				jQuery("#SQLquery").show();
			}        
        });
        
        jQuery("#SQLLayerList").change(function() {
        	updateSQLqueryFields();
        });
        
        jQuery(".SQLField").live("change",function() {
        	//Find the layer in the QueryLayers list
        	var layer = feMap.SQLqueryLayers[feMap.SQLqueryLayers.activeLayerIdx];
        	
        	//Find the selected field and retrieve its type
        	var fieldId = this.options[this.options.selectedIndex].value;
        	
        	var success = false;
        	for(var x =0; x < layer.attributes.length; x++) {
        		var field = layer.attributes[x];
        		if (field.name == fieldId) {
        			success = true;
        			
        			//Find the field type, and the SQL Operator dropdown for this row
        			var fieldType = field.type;
        			var SQLOperator = this.parentNode.children[1];
        			populateSQLOperator(fieldType, SQLOperator); 
        			break;
        		}
        	}
        	if (!success) {
        		alert("unable to find the matching query layer");
        		return null;
        	}
        	     	
        });
        
        function updateSQLqueryFields() {
        	//Update the dropdowns with the fields from this layer
        
	        //Remove any additional query levels from previous usages
	        jQuery('.rule').each(function (index, row) {
	            if(index > 0) {
	            	jQuery(this).remove();
	            }
	        });      
	        
        	//Find the layer in the QueryLayers list
        	var layerId = jQuery("#SQLLayerList").val();
        	var success = false;
        	for(var x =0; x < feMap.SQLqueryLayers.length; x++) {
        		var layer = feMap.SQLqueryLayers[x];
        		if (layer.id == layerId) {
        			success = true;
        			feMap.SQLqueryLayers.activeLayerIdx = x;
        			break;
        		}
        	}
        	if (!success) {
        		alert("unable to find the matching query layer");
        		return null;
        	} else if (layer.attributes == null) {
				alert("no attributes defined for this layer");
				return null;
			}
        	
        	//Add the layer's fields to the Fields dropdown. Use the alias if specified
        	jQuery(".SQLField").empty();
        	for(var y = 0; y < layer.attributes.length; y++) {
        		var field = layer.attributes[y];
        		if(field.query) {
	        		var alias = field.alias || field.name;
	        		var option = new Option(alias,field.name);
	        		jQuery(".SQLField").append(option);
	        	}
           	}
        	  	
        }
              
      }
      
      function populateSQLOperator(fieldType, SQLOperator) {
      	if(fieldType in inArray(["esriFieldTypeInteger","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeDouble","esriFieldTypeSingle","esriFieldTypeOID"])) {
      		
      		//Add SQL operators relevant for numbers
      		jQuery(SQLOperator).empty();
      		jQuery(SQLOperator).append(new Option("equals","="));
      		jQuery(SQLOperator).append(new Option("does not equal","!="));
      		jQuery(SQLOperator).append(new Option("is less than","<")); //TODO should this be LIKE?
      		jQuery(SQLOperator).append(new Option("is greater than",">"));
      	} else if (fieldType == "esriFieldTypeString")  {
      		
      		//Add SQL operators relevant for text
      		jQuery(SQLOperator).empty();
      		jQuery(SQLOperator).append(new Option("equals","="));
      		jQuery(SQLOperator).append(new Option("does not equal","!="));
      		jQuery(SQLOperator).append(new Option("contains","contains")); //TODO should this be LIKE?
      		jQuery(SQLOperator).append(new Option("starts with","starts with"));
      		jQuery(SQLOperator).append(new Option("ends with","ends with"));
      	}      	
      }
      
      function inArray(a)
      //tests whether a value is found in an array
      {
        var o = {};
        for(var i=0;i<a.length;i++)
        {
          o[a[i]]='';
        }
        return o;
      }
      


      dojo.addOnLoad(init);
    </script> 
  </head> 
	<body class="claro"> 
		<div style="position:relative;width:100%;height:100%;"> 
			<div id="map" style="width:100%;height:100%;">
			
				<button id="btnSQLquery" type="button">Select by Attributes</button>
				
				<div id="SQLquery" class="draggable">
					<div id="wrapper">
						<div id="rule-header"> Select By Attributes </div>
						<form>
							<div id="SQLLayers">
								<select id="SQLLayerList">
								</select>
							</div>
							<div id="rule-group">
								<div class="rule" id="rule">
									<select class="SQLField"></select>
									<select class="SQLOperator"></select>
									<input class="SQLType" type="text" />
									<a href="#" class="minus"></a> <a href="#" class="plus"></a>
								</div>
							</div>
						</form>
					</div><!--wrapper-->
				</div> <!--SQLquery-->
	
	
			</div> <!--map-->
		</div> <!--page-->
	</body> 
</html>