<!doctype html>
<html lang="en">
<head>
<title>KML error repro case</title>
<script>var dojoConfig = { parseOnLoad: true };</script>
<script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.2"></script>
<script>
    
  function init() {

	var elevationLayerDef = {
		"id": "elevDocs",
		"url": "http://nsw-coastal-explorer.domorewithmaps.com/map/kml/nsw-elevations-docs.1.3.kmz"
	};
	
	var beachLayerDef = {
		"id": "beachDocs",
		"url": "http://nsw-coastal-explorer.domorewithmaps.com/map/kml/nsw-beaches-docs.1.3.kmz"
	};	

	//Call the utility.arcgis.com/kml service the first time
    var elevLayer = buildKmlLayer(elevationLayerDef);
    
    //Call the utility.arcgis.com/kml service the second time
    //With a delay less than about 500ms, an error message will often be shown, even using refresh=true
    setTimeout(function(){
    	var beachLayer = buildKmlLayer(beachLayerDef);
    },5);
    
    function buildKmlLayer(newLayer) {
    	console.log("processing layer ",newLayer.id);
    	var url = "http://utility.arcgis.com/sharing/kml?url=" + newLayer.url + "&refresh=true";
    	
    	var kmlRequest = esri.request({
    		 id: newLayer.id,
    	     url: url,
    	     content: {
    	       f:  "json"
    	     },
    	     handleAs: "json",
    	     callbackParamName: "callback",
    	     load: function() {
    	     	console.log("inside success function for ",arguments[1].args.id);    	     
    	     },
    	     error: kmlFailed
    	});
    }
    
    function kmlFailed(error) {
      console.log("Error with layer ",arguments[1].args.id, error.message);
    }
       
  }
  dojo.ready(init);
</script>
</head>

<body><p>See the firebug console</p></body>
</html>
